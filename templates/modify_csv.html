{% extends "base.html" %}
{% block title %}Modify CSV{% endblock %}
{% block content %}
<h1>Modify CSV File</h1>

<form action="{{ url_for('modify_csv') }}" method="post" enctype="multipart/form-data">
  <div class="upload-section">
    <label for="modfile">CSV File:</label>
    <input type="file" id="modfile" name="modfile" required>
    <button type="submit" class="btn upload-btn-space">
  <i class="bi bi-upload upload-btn-icon"></i>Upload & Analyze
    </button>
  </div>
</form>

{% if columns %}
<form action="{{ url_for('modify_csv') }}" method="post">
  <input type="hidden" name="modfile_path" value="{{ modfile_path }}">
  <table class="table" style="margin-top:18px;">
    <thead>
      <tr>
        <th>#</th>
        <th>Column</th>
        <th>Type</th>
        <th>Existing Format</th>
        <th>New Type</th>
        <th>Action</th>
        <th>Modify Options</th>
      </tr>
    </thead>

    <!-- existing columns (first tbody) -->
    <tbody id="existing-cols">
      {% for col in columns %}
        {# sanitize column name for id usage (replace spaces, dots, dashes) #}
        {% set cid = col.name | replace(' ', '_') | replace('.', '_') | replace('-', '_') %}
      <tr>
        <td>{{ loop.index0|excel_col }}</td>
        <td>{{ col.name }}</td>
        <td>{{ col.type }}</td>
        <td>
          {% if col.type == 'Date' or col.type == 'DateTime' %}
            {{ col.format if col.format else 'N/A' }}
          {% else %}
            N/A
          {% endif %}
        </td>
        <td>
          <select name="new_type_{{ col.name }}">
            <option value="{{ col.type }}">{{ col.type }}</option>
            <option value="Text">Text</option>
            <option value="Integer">Integer</option>
            <option value="Float">Float</option>
            <option value="Date">Date</option>
            <option value="DateTime">DateTime</option>
            <option value="Boolean">Boolean</option>
          </select>
        </td>
        <td>
          <select name="action_{{ col.name }}" onchange="toggleModify(this, '{{ cid }}')">
            <option value="keep">Keep</option>
            <option value="modify">Modify</option>
            <option value="delete">Delete</option>
          </select>
        </td>
        <td>
          <div id="modify_opts_{{ cid }}" style="display:none;">
            <select name="mod_type_{{ col.name }}" onchange="showModifyFields(this, '{{ cid }}')">
              <option value="replace">Replace Value</option>
              <option value="concat">Concatenate Columns</option>
              <option value="datefmt">Change Date Format</option>
            </select>

            <div id="replace_field_{{ cid }}" style="display:block; margin-top:8px;">
              <input type="text" name="new_value_{{ col.name }}" placeholder="New value" style="width:260px; padding:6px;">
            </div>

            <div id="concat_field_{{ cid }}" style="display:none; margin-top:8px;">
              <!-- Avoid quoting issues: show example as A,B -->
              <input type="text" name="concat_cols_{{ col.name }}" placeholder="Columns to concatenate e.g. A,B" style="width:320px; padding:6px;">
            </div>

            <div id="datefmt_field_{{ cid }}" style="display:none; margin-top:8px;">
              <input type="text" name="datefmt_modify_{{ col.name }}" placeholder="New date format e.g. dd/MM/yyyy" style="width:260px; padding:6px;">
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>

    <!-- new rows will be appended here -->
    <tbody id="new-cols-tbody"></tbody>

    <tfoot>
      <tr>
        <td colspan="7" style="text-align:right;">
          <button type="button" id="add-new-col-btn" class="btn" onclick="addNewColRow()">+ Add New Column</button>
        </td>
      </tr>
    </tfoot>
  </table>

  <button type="submit" class="btn" style="margin-top:18px;">Apply & Download CSV</button>
</form>
{% endif %}

<style>
  .delete-col-btn {
    background: none;
    border: none;
    padding: 0;
    margin-left: 8px;
    cursor: pointer;
    transition: color 0.2s;
  }
  .delete-col-btn i {
    font-size: 1.4em;
    color: #e74c3c;
    transition: color 0.2s, text-shadow 0.2s, transform 0.2s;
  }
  .delete-col-btn:hover i {
    color: #c0392b;
    text-shadow: 0 0 6px #e74c3c;
    transform: scale(1.2);
  }
</style>

<script>
  let newColCount = 0;

  function addNewColRow() {
    newColCount++;
    const newTbody = document.getElementById('new-cols-tbody');
    const rowId = `new_col_${newColCount}`;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>New</td>
  <td><input type="text" name="new_col_name_${newColCount}" placeholder="New column name" class="new-col-input"></td>
      <td>N/A</td>
      <td>N/A</td>
      <td>
        <select name="new_type_${newColCount}">
          <option value="Text">Text</option>
          <option value="Integer">Integer</option>
          <option value="Float">Float</option>
          <option value="Date">Date</option>
          <option value="DateTime">DateTime</option>
          <option value="Boolean">Boolean</option>
        </select>
      </td>
      <td>
        <select name="action_${newColCount}" onchange="toggleModify(this, '${rowId}')">
          <option value="keep">Keep</option>
          <option value="modify">Modify</option>
          <option value="delete">Delete</option>
        </select>
      </td>
      <td>
        <div id="modify_opts_${rowId}" style="display:none;">
          <select name="mod_type_${newColCount}" onchange="showModifyFields(this, '${rowId}')">
            <option value="replace">Replace Value</option>
            <option value="concat">Concatenate Columns</option>
            <option value="datefmt">Change Date Format</option>
          </select>
          <div id="replace_field_${rowId}" style="display:block; margin-top:8px;">
            <input type="text" name="new_value_${newColCount}" placeholder="New value" style="width:260px; padding:6px;">
          </div>
          <div id="concat_field_${rowId}" style="display:none; margin-top:8px;">
            <input type="text" name="concat_cols_${newColCount}" placeholder="Columns to concatenate e.g. A,B" style="width:320px; padding:6px;">
          </div>
          <div id="datefmt_field_${rowId}" style="display:none; margin-top:8px;">
            <input type="text" name="datefmt_modify_${newColCount}" placeholder="New date format e.g. dd/MM/yyyy" style="width:260px; padding:6px;">
            <input type="text" name="datefmt_source_col_${newColCount}" placeholder="Source column (A, B, ...)" style="width:180px; padding:6px; margin-left:8px;">
          </div>
        </div>
        <button type="button" class="delete-col-btn" title="Delete column" onclick="deleteNewColRow(this)">
          <i class="bi bi-trash3-fill"></i>
        </button>
      </td>
    `;

    // append into the dedicated tbody for new rows
    newTbody.appendChild(row);

    // debug info (open browser console to view)
    if (window.console && console.log) console.log('Added new column row:', rowId);
  }

  function deleteNewColRow(btn) {
    const row = btn.closest('tr');
    if (row) row.remove();
  }

  function toggleModify(sel, col) {
    var div = document.getElementById('modify_opts_' + col);
    if (div) div.style.display = sel.value === 'modify' ? 'block' : 'none';
  }

  function showModifyFields(sel, col) {
    var replaceDiv = document.getElementById('replace_field_' + col);
    var concatDiv = document.getElementById('concat_field_' + col);
    var datefmtDiv = document.getElementById('datefmt_field_' + col);
    if (replaceDiv) replaceDiv.style.display = 'none';
    if (concatDiv) concatDiv.style.display = 'none';
    if (datefmtDiv) datefmtDiv.style.display = 'none';
    if (sel.value === 'replace') {
      if (replaceDiv) replaceDiv.style.display = 'block';
    } else if (sel.value === 'concat') {
      if (concatDiv) concatDiv.style.display = 'block';
    } else if (sel.value === 'datefmt') {
      if (datefmtDiv) datefmtDiv.style.display = 'block';
    }
  }
</script>

{% endblock %}
